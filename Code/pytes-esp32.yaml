substitutions:
  device_name: pytes-esp32
  friendly_name: ğŸ”‹Pytes RS232ğŸ”‹
  poll_s: "30"
  capacity_ah: "100"
  num_batts: "6"
  version: 1.4.1
  device_description: "Pytes Monitor RS-232"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  comment: ${device_description}

esp32:
  board: esp32dev
  framework:
    type: esp-idf
    advanced: 
      minimum_chip_revision: "3.1"

# ESPHome 2025.12+ : custom_component removed -> use external component
# Ejecutar via SSH "mkdir -p /config/esphome/components/pytes_rs232"
external_components:
  - source:
      type: local
      path: components

logger:
  level: INFO

web_server:
  port: 80  

# API de Home Assistant
api:
  encryption:
    key: "Your key"

# OTA
ota:
  - platform: esphome
    password: "Your Password"
  - platform: web_server

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

# ============================================
# NTP TIME SYNC - AST -4
# ============================================
time:
  - platform: sntp
    id: sntp_time
    timezone: AST4
    servers:
      - time.google.com
    update_interval: 4h
    on_time_sync:
      then:
        - logger.log: "Time synchronized with NTP server"

# ============================================
# I2C - BME280 (Temp/Press/Hum)
# ============================================
i2c:
  sda: GPIO21
  scl: GPIO22
  scan: true
  frequency: 100kHz

# ============================================
# UART - MAX3232 (RS-232)
# ============================================
uart:
  id: uart_pytes
  tx_pin: GPIO17
  rx_pin: GPIO16
  baud_rate: 115200
  data_bits: 8
  parity: NONE
  stop_bits: 1

# ---------- SENSORS ----------
sensor:
  # ============================================
  # BME280 - Temperatura/PresiÃ³n/Humedad Ambiente
  # ============================================
  - platform: bme280_i2c
    temperature:
      name: "ğŸŒ¡ï¸ Ambient Temperature"
      id: ambient_temp_f
      unit_of_measurement: "Â°F"
      accuracy_decimals: 1
      oversampling: 16x
      filters:
        # C -> F
        - lambda: return (x * 9.0 / 5.0) + 32.0;
    pressure:
      name: "ğŸŒ€ Ambient Pressure"
      id: ambient_pressure_inhg
      unit_of_measurement: "inHg"
      accuracy_decimals: 2
      filters:
        # hPa -> inHg (1 hPa = 0.0295299830714 inHg)
        - lambda: return x * 0.0295299830714;
    humidity:
      name: "ğŸ’§ Ambient Humidity"
      id: ambient_humidity
    address: 0x76 
    update_interval: 60s

  - platform: uptime
    id: uptime_seconds
    internal: true
    update_interval: 60s

  - platform: wifi_signal
    name: "WiFi RSSIğŸ“¶"
    id: wifi_rssi
    unit_of_measurement: "dBm"
    accuracy_decimals: 0
    update_interval: 60s
    entity_category: diagnostic
    
# ---------- SENSORS ----------
  - platform: template
    name: "Bank Voltage âš ï¸"
    id: sys_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2

  - platform: template
    name: "Bank Currentâš¡"
    id: sys_current
    unit_of_measurement: "A"
    accuracy_decimals: 2

  - platform: template
    name: "Bank TempğŸŒ¡ï¸"
    id: sys_temp_f
    unit_of_measurement: "Â°F"
    accuracy_decimals: 1

  - platform: template
    name: "Bank SoCğŸ“ˆ"
    id: sys_coulomb
    unit_of_measurement: "%"
    accuracy_decimals: 0

  # ---- Battery 1 ----
  - platform: template
    name: "B1 Voltâš ï¸"
    id: b1_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
  - platform: template
    name: "B1 Currentâš¡"
    id: b1_current
    unit_of_measurement: "A"
    accuracy_decimals: 2
  - platform: template
    name: "B1 TempğŸŒ¡ï¸"
    id: b1_temp_f
    unit_of_measurement: "Â°F"
    accuracy_decimals: 1
  - platform: template
    name: "B1 SoCğŸ“ˆ"
    id: b1_coulomb
    unit_of_measurement: "%"
    accuracy_decimals: 0

# ---- Battery 2 ----
  - platform: template
    name: "B2 Voltâš ï¸"
    id: b2_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
  - platform: template
    name: "B2 Currentâš¡"
    id: b2_current
    unit_of_measurement: "A"
    accuracy_decimals: 2
  - platform: template
    name: "B2 TempğŸŒ¡ï¸"
    id: b2_temp_f
    unit_of_measurement: "Â°F"
    accuracy_decimals: 1
  - platform: template
    name: "B2 SoCğŸ“ˆ"
    id: b2_coulomb
    unit_of_measurement: "%"
    accuracy_decimals: 0

  # ---- Battery 3 ----
  - platform: template
    name: "B3 Voltâš ï¸"
    id: b3_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
  - platform: template
    name: "B3 Currentâš¡"
    id: b3_current
    unit_of_measurement: "A"
    accuracy_decimals: 2
  - platform: template
    name: "B3 TempğŸŒ¡ï¸"
    id: b3_temp_f
    unit_of_measurement: "Â°F"
    accuracy_decimals: 1
  - platform: template
    name: "B3 SoCğŸ“ˆ"
    id: b3_coulomb
    unit_of_measurement: "%"
    accuracy_decimals: 0

  # ---- Battery 4 ----
  - platform: template
    name: "B4 Voltâš ï¸"
    id: b4_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
  - platform: template
    name: "B4 Currentâš¡"
    id: b4_current
    unit_of_measurement: "A"
    accuracy_decimals: 2
  - platform: template
    name: "B4 TempğŸŒ¡ï¸"
    id: b4_temp_f
    unit_of_measurement: "Â°F"
    accuracy_decimals: 1
  - platform: template
    name: "B4 SoCğŸ“ˆ"
    id: b4_coulomb
    unit_of_measurement: "%"
    accuracy_decimals: 0

  # ---- Battery 5 ----
  - platform: template
    name: "B5 Voltâš ï¸"
    id: b5_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
  - platform: template
    name: "B5 Currentâš¡"
    id: b5_current
    unit_of_measurement: "A"
    accuracy_decimals: 2
  - platform: template
    name: "B5 TempğŸŒ¡ï¸"
    id: b5_temp_f
    unit_of_measurement: "Â°F"
    accuracy_decimals: 1
  - platform: template
    name: "B5 SoCğŸ“ˆ"
    id: b5_coulomb
    unit_of_measurement: "%"
    accuracy_decimals: 0

  # ---- Battery 6 ----
  - platform: template
    name: "B6 Voltâš ï¸"
    id: b6_voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
  - platform: template
    name: "B6 Currentâš¡"
    id: b6_current
    unit_of_measurement: "A"
    accuracy_decimals: 2
  - platform: template
    name: "B6 TempğŸŒ¡ï¸"
    id: b6_temp_f
    unit_of_measurement: "Â°F"
    accuracy_decimals: 1
  - platform: template
    name: "B6 SoCğŸ“ˆ"
    id: b6_coulomb
    unit_of_measurement: "%"
    accuracy_decimals: 0

text_sensor:
  # Summary status
  - platform: template
    name: "Bank StatusğŸš¥"
    id: sys_basic_status

  # Battery 1
  - platform: template
    name: "B1 Serial#ï¸âƒ£"
    id: b1_barcode
  - platform: template
    name: "B1 ModelğŸ†”"
    id: b1_devtype
  - platform: template
    name: "B1 Firmwareâš™ï¸"
    id: b1_firmver
  - platform: template
    name: "B1 StatusğŸš¥"
    id: b1_basic_status
  - platform: template
    name: "B1 Volt StatusğŸ“Š"
    id: b1_volt_status

  # Battery 2
  - platform: template
    name: "B2 Serial#ï¸âƒ£"
    id: b2_barcode
  - platform: template
    name: "B2 ModelğŸ†”"
    id: b2_devtype
  - platform: template
    name: "B2 Firmwareâš™ï¸"
    id: b2_firmver
  - platform: template
    name: "B2 StatusğŸš¥"
    id: b2_basic_status
  - platform: template
    name: "B2 Volt StatusğŸ“Š"
    id: b2_volt_status

  # Battery 3
  - platform: template
    name: "B3 Serial#ï¸âƒ£"
    id: b3_barcode
  - platform: template
    name: "B3 ModelğŸ†”"
    id: b3_devtype
  - platform: template
    name: "B3 Firmwareâš™ï¸"
    id: b3_firmver
  - platform: template
    name: "B3 StatusğŸš¥"
    id: b3_basic_status
  - platform: template
    name: "B3 Volt StatusğŸ“Š"
    id: b3_volt_status

  # Battery 4
  - platform: template
    name: "B4 Serial#ï¸âƒ£"
    id: b4_barcode
  - platform: template
    name: "B4 ModelğŸ†”"
    id: b4_devtype
  - platform: template
    name: "B4 Firmwareâš™ï¸"
    id: b4_firmver
  - platform: template
    name: "B4 StatusğŸš¥"
    id: b4_basic_status
  - platform: template
    name: "B4 Volt StatusğŸ“Š"
    id: b4_volt_status

  # Battery 5
  - platform: template
    name: "B5 Serial#ï¸âƒ£"
    id: b5_barcode
  - platform: template
    name: "B5 ModelğŸ†”"
    id: b5_devtype
  - platform: template
    name: "B5 Firmwareâš™ï¸"
    id: b5_firmver
  - platform: template
    name: "B5 StatusğŸš¥"
    id: b5_basic_status
  - platform: template
    name: "B5 Volt StatusğŸ“Š"
    id: b5_volt_status

  # Battery 6
  - platform: template
    name: "B6 Serial#ï¸âƒ£"
    id: b6_barcode
  - platform: template
    name: "B6 ModelğŸ†”"
    id: b6_devtype
  - platform: template
    name: "B6 Firmwareâš™ï¸"
    id: b6_firmver
  - platform: template
    name: "B6 StatusğŸš¥"
    id: b6_basic_status
  - platform: template
    name: "B6 Volt StatusğŸ“Š"
    id: b6_volt_status

# ----------------------------
# DIAGNOSTIC
# ----------------------------

  # ----------------------------
  # ESP32 - Uptime readable
  # ----------------------------
  - platform: template
    name: "UptimeğŸ•“"
    icon: mdi:clock-start
    entity_category: diagnostic
    update_interval: 60s
    lambda: |-
      int seconds = (int)id(uptime_seconds).state;
      int days = seconds / 86400;
      int hours = (seconds % 86400) / 3600;
      int minutes = (seconds % 3600) / 60;
      int secs = seconds % 60;

      std::string result = "";
      if (days > 0) result += to_string(days) + "d ";
      if (hours > 0) result += to_string(hours) + "h ";
      if (minutes > 0) result += to_string(minutes) + "m ";
      result += to_string(secs) + "s";

      return result;

  - platform: template
    name: "DateğŸ—“ï¸"
    icon: mdi:calendar-clock
    entity_category: diagnostic
    update_interval: 60s
    lambda: |-
      auto time = id(sntp_time).now();
      if (!time.is_valid()) {
        return {"Syncing..."};
      }

      int month = time.month;
      int day = time.day_of_month;
      int year = time.year;
      int hour = time.hour;
      int minute = time.minute;

      std::string am_pm = "am";
      int hour_12 = hour;

      if (hour == 0) {
        hour_12 = 12;
      } else if (hour == 12) {
        am_pm = "pm";
      } else if (hour > 12) {
        hour_12 = hour - 12;
        am_pm = "pm";
      }

      char buffer[30];
      snprintf(buffer, sizeof(buffer), "%d/%d/%d %d:%02d %s",
               month, day, year, hour_12, minute, am_pm.c_str());

      return {buffer};

  - platform: template
    name: "ESP32 Code Versionâš™ï¸"
    entity_category: diagnostic
    lambda: |-
      return {"${version}"};


# ---------- External component config ----------
pytes_rs232:
  uart_id: uart_pytes
  num_batteries: ${num_batts}
  update_interval: ${poll_s}s
  capacity_ah: ${capacity_ah}

  summary:
    voltage: sys_voltage
    current: sys_current
    temperature: sys_temp_f
    coulomb: sys_coulomb
    basic_status: sys_basic_status

  batteries:
    - voltage: b1_voltage
      current: b1_current
      temperature: b1_temp_f
      coulomb: b1_coulomb   # puedes usar "soc:" tambiÃ©n, es alias
      barcode: b1_barcode
      devtype: b1_devtype
      firm_version: b1_firmver
      basic_status: b1_basic_status
      volt_status: b1_volt_status

    - voltage: b2_voltage
      current: b2_current
      temperature: b2_temp_f
      coulomb: b2_coulomb
      barcode: b2_barcode
      devtype: b2_devtype
      firm_version: b2_firmver
      basic_status: b2_basic_status
      volt_status: b2_volt_status

    - voltage: b3_voltage
      current: b3_current
      temperature: b3_temp_f
      coulomb: b3_coulomb
      barcode: b3_barcode
      devtype: b3_devtype
      firm_version: b3_firmver
      basic_status: b3_basic_status
      volt_status: b3_volt_status

    - voltage: b4_voltage
      current: b4_current
      temperature: b4_temp_f
      coulomb: b4_coulomb
      barcode: b4_barcode
      devtype: b4_devtype
      firm_version: b4_firmver
      basic_status: b4_basic_status
      volt_status: b4_volt_status

    - voltage: b5_voltage
      current: b5_current
      temperature: b5_temp_f
      coulomb: b5_coulomb
      barcode: b5_barcode
      devtype: b5_devtype
      firm_version: b5_firmver
      basic_status: b5_basic_status
      volt_status: b5_volt_status

    - voltage: b6_voltage
      current: b6_current
      temperature: b6_temp_f
      coulomb: b6_coulomb
      barcode: b6_barcode
      devtype: b6_devtype
      firm_version: b6_firmver
      basic_status: b6_basic_status
      volt_status: b6_volt_status
